name: Publish Docker Image to GitHub Container Registry

on:
  release:
    types: [ "created" ]
  push:
    branches:
      - test/workflow

env:
  REGISTRY: ghcr.io

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      repo-name-lower: ${{ steps.set-vars.outputs.repo-name-lower }}
      image-tag: ${{ steps.set-vars.outputs.image-tag }}
      cache-ref: ${{ steps.set-vars.outputs.cache-ref }}
      registry-image: ${{ steps.set-vars.outputs.registry-image }}
      push-latest: ${{ steps.set-vars.outputs.push-latest }}
    steps:
      - name: Set variables
        id: set-vars
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_NAME_LOWER=$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')
          REGISTRY_IMAGE="${{ env.REGISTRY }}/${REPO_NAME_LOWER}"
          GIT_REF="${GITHUB_REF:-${{ github.ref }}}"

          PUSH_LATEST="false"

          if [[ "$GIT_REF" == refs/tags/* ]]; then
            IMAGE_TAG=${GIT_REF#refs/tags/}
            CACHE_REF=release
            
            echo "Current Tag: $IMAGE_TAG"

            LATEST_API_TAG=$(gh release view --repo "${{ github.repository }}" --json tagName --jq '.tagName' || echo "")

            echo "API Latest Tag: $LATEST_API_TAG"
            
            if [[ "$IMAGE_TAG" == "$LATEST_API_TAG" ]]; then
              PUSH_LATEST="true"
            fi

          elif [[ "$GIT_REF" == refs/heads/test/workflow ]]; then
            IMAGE_TAG=test-workflow
            CACHE_REF=test-workflow
          else
            BRANCH_NAME=${GIT_REF#refs/heads/}
            SAFE_BRANCH_NAME=${BRANCH_NAME//\//-}
            IMAGE_TAG=${SAFE_BRANCH_NAME}
            CACHE_REF=branch-${SAFE_BRANCH_NAME}
          fi

          echo "repo-name-lower=$REPO_NAME_LOWER" >> $GITHUB_OUTPUT
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "cache-ref=$CACHE_REF" >> $GITHUB_OUTPUT
          echo "registry-image=$REGISTRY_IMAGE" >> $GITHUB_OUTPUT
          echo "push-latest=$PUSH_LATEST" >> $GITHUB_OUTPUT

  build:
    needs: prepare
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-24.04
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
          - platform: linux/arm/v7
            runner: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ matrix.platform }}
          outputs: type=image,name=${{ needs.prepare.outputs.registry-image }},push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=${{ needs.prepare.outputs.cache-ref }}-${{ matrix.platform }}
          cache-to: type=gha,mode=max,scope=${{ needs.prepare.outputs.cache-ref }}-${{ matrix.platform }}

      - run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"
      
      - uses: actions/upload-artifact@v4
        with:
          name: digests-${{ strategy.job-index }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

  merge:
    runs-on: ubuntu-latest
    needs: [prepare, build]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true
      
      - uses: docker/setup-buildx-action@v3
      
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - working-directory: /tmp/digests
        run: |
          TAGS="-t ${{ needs.prepare.outputs.registry-image }}:${{ needs.prepare.outputs.image-tag }}"
          
          if [[ "${{ needs.prepare.outputs.push-latest }}" == "true" ]]; then
            TAGS="$TAGS -t ${{ needs.prepare.outputs.registry-image }}:latest"
            echo "üè∑Ô∏è Adding 'latest' tag"
          fi
          
          docker buildx imagetools create $TAGS \
            $(printf '${{ needs.prepare.outputs.registry-image }}@sha256:%s ' *)        

      - run: |
          docker buildx imagetools inspect ${{ needs.prepare.outputs.registry-image }}:${{ needs.prepare.outputs.image-tag }}